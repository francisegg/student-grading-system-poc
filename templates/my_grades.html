<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„æˆç¸¾å„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        .header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .btn {
            text-decoration: none; background: #6c757d; color: white; padding: 8px 15px; border-radius: 5px; font-size: 0.9em;
        }

        .card {
            background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px;
        }
        .card h3 { margin-top: 0; color: #333; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }

        .score-val { font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“ {{ .User.Name }} çš„å­¸ç¿’æ­·ç¨‹</h1>
        <a href="/" class="btn">â¬… å›é¦–é </a>
    </div>

    <div class="card">
        <h3>ğŸ“ˆ ç©åˆ†ç´¯ç©è¶¨å‹¢åœ–</h3>
        <canvas id="gradeChart" height="120"></canvas>
    </div>

    <div class="card">
        <h3>ğŸ“„ è©³ç´°æˆç¸¾æ•¸æ“š</h3>
        <table>
            <thead>
                <tr>
                    <th>è©•é‡é …ç›®</th>
                    <th>å–®æ¬¡åˆ†æ•¸</th>
                    <th>ç´¯è¨ˆç©åˆ†</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // 1. å¾ Go å¾Œç«¯æ¥æ”¶åŸå§‹è³‡æ–™
    // é€™è£¡åªæ¥æ”¶æœ€åŸå§‹çš„ã€Œå–®æ¬¡åˆ†æ•¸ã€èˆ‡ã€Œé …ç›®åç¨±ã€
    const rawLabels = [
        {{ range .Grades }}"{{ .ItemName }}",{{ end }}
    ];

    const rawScores = [
        {{ range .Grades }}{{ .Score }},{{ end }}
    ];

    // 2. è¨ˆç®—ç´¯è¨ˆåˆ†æ•¸ (Cumulative Calculation)
    let runningTotal = 0;
    const cumulativeScores = rawScores.map(score => {
        runningTotal += score;
        return parseFloat(runningTotal.toFixed(2)); // ä¿æŒå…©ä½å°æ•¸é¿å…æµ®é»æ•¸èª¤å·®
    });

    // 3. æ¸²æŸ“åœ–è¡¨
    const ctx = document.getElementById('gradeChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: rawLabels,
            datasets: [{
                label: 'ç´¯è¨ˆç¸½åˆ†',
                data: cumulativeScores, // åœ–è¡¨ç•«çš„æ˜¯ç´¯è¨ˆåˆ†æ•¸
                borderColor: '#4285F4',
                backgroundColor: 'rgba(66, 133, 244, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#ea4335', // é»é»æ”¹æˆç´…è‰²æ¯”è¼ƒé¡¯çœ¼
                pointRadius: 5,
                pointHoverRadius: 8,
                fill: true,
                tension: 0.4 // ç·šæ¢åœ“æ»‘ä¸€é»
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† max: 100ï¼Œå› ç‚ºç´¯è¨ˆåˆ†æ•¸æœƒä¸€ç›´å¾€ä¸ŠåŠ 
                    title: { display: true, text: 'ç›®å‰ç´¯è¨ˆç¸½åˆ†' }
                },
                x: {
                    title: { display: true, text: 'è©•é‡æ™‚é–“è»¸' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 },
                    callbacks: {
                        // --- é—œéµä¿®æ”¹ï¼šè‡ªè¨‚ Tooltip é¡¯ç¤ºå…§å®¹ ---
                        label: function(context) {
                            const index = context.dataIndex;
                            const currentScore = rawScores[index];   // è©²æ¬¡æ‹¿åˆ°çš„åˆ†æ•¸
                            const totalScore = context.raw;          // ç´¯è¨ˆçš„åˆ†æ•¸
                            
                            return [
                                `ğŸ”¹ ç•¶æ¬¡åˆ†æ•¸: +${currentScore}`,
                                `ğŸ”¸ ç´¯è¨ˆç©åˆ†: ${totalScore}`
                            ];
                        }
                    }
                }
            }
        }
    });

    // 4. è‡ªå‹•ç”Ÿæˆè¡¨æ ¼å…§å®¹ (ç¢ºä¿è¡¨æ ¼è·Ÿåœ–è¡¨çš„ç´¯è¨ˆé‚è¼¯ä¸€è‡´)
    const tableBody = document.getElementById('scoreTableBody');
    let tableHTML = '';
    
    // å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
    for (let i = rawLabels.length - 1; i >= 0; i--) {
        tableHTML += `
            <tr>
                <td>${rawLabels[i]}</td>
                <td style="color: #666;">+${rawScores[i]}</td>
                <td class="score-val" style="color: #4285F4;">${cumulativeScores[i]}</td>
            </tr>
        `;
    }
    tableBody.innerHTML = tableHTML;

</script>

</body>
</html>