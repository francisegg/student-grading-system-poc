<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„æˆç¸¾å„€è¡¨æ¿</title>
    <link rel="icon" type="image/jpeg" href="/static/cover.jpeg">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { text-decoration: none; background: #6c757d; color: white; padding: 8px 15px; border-radius: 5px; font-size: 0.9em; }
        
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px; }
        .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

        .charts-row { display: flex; gap: 20px; }
        .chart-box { flex: 1; min-width: 300px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #666; }
        .score-val { font-weight: bold; color: #4285F4; }

        .pr-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; float: right;
        }

        /* --- æ–°å¢é‡é»æ•¸æ“šå€æ¨£å¼ --- */
        .metrics-row { display: flex; gap: 20px; margin-bottom: 25px; }
        .metric-card {
            flex: 1; background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #ddd;
        }
        .metric-title { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .metric-value { font-size: 2em; font-weight: bold; color: #333; }
        .metric-sub { font-size: 0.8em; color: #999; margin-top: 5px; }
        .card-blue { border-left-color: #4285F4; }
        .card-green { border-left-color: #34A853; }
        .card-orange { border-left-color: #FBBC05; }
        
        @media (max-width: 768px) { 
            .charts-row { flex-direction: column; } 
            .metrics-row { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“ {{ .User.Name }} çš„å­¸ç¿’æ­·ç¨‹</h1>
        <a href="/" class="btn">â¬… å›é¦–é </a>
    </div>

    <div class="metrics-row">
        <div class="metric-card card-blue">
            <div class="metric-title">ç›®å‰ç´¯ç©ç¸½åˆ†</div>
            <div class="metric-value">{{ printf "%.1f" .MyTotal }}</div>
            <div class="metric-sub">åˆ†</div>
        </div>

        <div class="metric-card card-orange">
            <div class="metric-title">æœŸæœ«ä½”æ¯” (å‰©é¤˜æ¬Šé‡)</div>
            <div class="metric-value">{{ printf "%.1f" .FinalWeight }}%</div>
            <div class="metric-sub">è·é›¢æ»¿åˆ†é‚„å·®</div>
        </div>

        <div class="metric-card card-green">
            <div class="metric-title">ğŸ† å…¨ç­å‰ä¸‰é«˜åˆ†</div>
            <div style="text-align: left; display: inline-block; margin-top: 5px;">
                {{ range $i, $score := .Top3 }}
                    <div style="font-size: 1.1em; color: #444; margin: 4px 0;">
                        <span style="margin-right:8px;">{{ if eq $i 0 }}ğŸ¥‡{{ else if eq $i 1 }}ğŸ¥ˆ{{ else }}ğŸ¥‰{{ end }}</span> 
                        <b>{{ $score }}</b> åˆ†
                    </div>
                {{ end }}
            </div>
        </div>
    </div>

    <div class="charts-row">
        <div class="card chart-box">
            <h3>ğŸ“ˆ ç©åˆ†ç´¯ç©è¶¨å‹¢</h3>
            <canvas id="trendChart" height="200"></canvas>
        </div>
        <div class="card chart-box">
            <div>
                <h3>
                    ğŸ“Š å…¨ç­è½é»åˆ†æ
                    <span class="pr-badge">è´é {{ .Percentile }}% çš„åŒå­¸</span>
                </h3>
            </div>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 5px;">
                ç›®å‰ç¸½åˆ†ï¼š<b>{{ .MyTotal }}</b> / å…¨ç­å¹³å‡ï¼š<b>{{ printf "%.1f" .ClassMean }}</b>
            </p>
            <p style="font-size: 0.8em; color: #999; margin: 0;">
                (å…¨ç­ç¯„åœï¼š{{ .ClassMin }} ~ {{ .ClassMax }} åˆ†)
            </p>
            <canvas id="distributionChart" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“„ è©³ç´°æˆç¸¾æ•¸æ“š</h3>
        <table>
            <thead>
                <tr>
                    <th>è©•é‡é …ç›®</th>
                    <th>å–®æ¬¡åˆ†æ•¸</th>
                    <th>ç´¯è¨ˆç©åˆ†</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- JavaScript é‚è¼¯ä¿æŒä¸è®Š ---
    const rawLabels = [{{ range .Grades }}"{{ .ItemName }}",{{ end }}];
    const rawScores = [{{ range .Grades }}{{ .Score }},{{ end }}];
    const myTotalScore = {{ .MyTotal }};
    const classMean = {{ .ClassMean }};
    const classStdDev = {{ .ClassStdDev }};
    const classMin = {{ .ClassMin }};
    const classMax = {{ .ClassMax }};

    let runningTotal = 0;
    const cumulativeScores = rawScores.map(score => {
        runningTotal += score;
        return parseFloat(runningTotal.toFixed(2));
    });

    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: rawLabels,
            datasets: [{
                label: 'ç´¯è¨ˆç¸½åˆ†',
                data: cumulativeScores,
                borderColor: '#4285F4',
                backgroundColor: 'rgba(66, 133, 244, 0.1)',
                borderWidth: 2,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#ea4335',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    const startX = Math.floor(classMin);
    const endX = Math.ceil(classMax);
    const step = (endX - startX) / 60;

    const distData = [];
    const distLabels = [];
    for (let x = startX; x <= endX; x += step) {
        let y = 0;
        if (classStdDev > 0) {
            y = (1 / (classStdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - classMean) / classStdDev, 2));
        } else {
            y = (Math.abs(x - classMean) < 1) ? 1 : 0;
        }
        distLabels.push(x.toFixed(0));
        distData.push({ x: x, y: y });
    }

    const myRangeData = distData.map(p => {
        return p.x <= myTotalScore ? p.y : null;
    });

    const ctxDist = document.getElementById('distributionChart').getContext('2d');
    new Chart(ctxDist, {
        type: 'line',
        data: {
            labels: distLabels,
            datasets: [
                {
                    label: 'å…¨ç­åˆ†ä½ˆ',
                    data: distData.map(p => p.y),
                    borderColor: '#ddd',
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'æˆ‘çš„ä½ç½®',
                    data: myRangeData,
                    borderColor: 'rgba(118, 75, 162, 1)',
                    backgroundColor: 'rgba(118, 75, 162, 0.5)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: {
                x: { title: { display: true, text: 'ç¸½åˆ†å€é–“ (Min ~ Max)' }, ticks: { maxTicksLimit: 6 } },
                y: { display: false }
            }
        }
    });

    const tableBody = document.getElementById('scoreTableBody');
    let tableHTML = '';
    for (let i = rawLabels.length - 1; i >= 0; i--) {
        tableHTML += `
            <tr>
                <td>${rawLabels[i]}</td>
                <td style="color: #666;">+${rawScores[i]}</td>
                <td class="score-val">${cumulativeScores[i]}</td>
            </tr>
        `;
    }
    tableBody.innerHTML = tableHTML;
</script>

</body>
</html>